# 收盘数据归档与开发环境准备计划

为了满足您在收盘后（以及未来几天）继续开发调试的需求，我们需要将今天的“鲜活数据”完整保存下来，并确保开发环境能方便地读取这些数据。

## 1. 核心目标
1.  **逐笔数据 (Ticks)**: 强制执行最后一次全量抓取，确保 15:00 收盘前的所有 L2 交易记录入库。
2.  **情绪数据 (Sentiment)**: 确保数据库中已存储了当天的分钟级快照（CVD/委差）。
3.  **历史聚合 (Aggregation)**: 基于今天的全量 Ticks，计算出今天的“资金流向日线数据”（净流入、主力占比），写入 `local_history` 表，以便历史分析页面能看到今天的数据点。

## 2. 执行方案 (Action Plan)

### 步骤一：创建归档脚本 (`backend/scripts/finalize_data.py`)
我们将编写一个 Python 脚本，一键完成所有收盘工作：
1.  **Force Fetch**: 遍历 `watchlist`，调用 `ak.stock_zh_a_tick_tx_js` 拉取全天数据并存入 `trade_ticks`。
2.  **Auto Aggregate**: 遍历 `watchlist`，调用 `perform_aggregation`，计算今日的主力资金流向并存入 `local_history`。
3.  **Report**: 输出每个股票的数据条数，确认归档成功。

### 步骤二：模拟/回放支持 (Simulated/Playback Mode)
这是一个关键点。如果您明天（2月13日）继续开发，代码默认会读取 `datetime.now()` (即 13日) 的数据，但那是空的。
为了让您能“复用”今天（2月12日）的数据，我们需要一个小开关。

**修改 `backend/app/routers/market.py` 和 `monitor.py`**:
*   引入一个环境变量或配置 `MOCK_DATE`。
*   如果设置了 `MOCK_DATE` (例如 "2026-02-12")，后端所有接口将强制读取该日期的数据，而不是当天日期。
*   这样，无论您哪天开发，都能看到今天这批完美的收盘数据。

### 步骤三：执行归档
*   运行脚本，锁定数据。

## 3. 待确认项
*   **模拟日期开关**：我建议直接在 `backend/app/core/config.py` 中增加一个 `MOCK_DATA_DATE` 配置项，默认为空。当您需要回放数据时，填入日期即可。是否同意？

如果同意，我将先创建归档脚本并执行，确保存下数据，然后添加模拟日期功能。