# V3.0 终极修正方案：独立实时区容器 + 真实价格源排查

## 1. 核心需求再分析

1. **物理隔离的实时区**：

   * 用户要求“真的做一个区域”、“有一个框框出来”、“右边留 5% 独立区域”。

   * **结论**：不能只在 Recharts 图表内部做手脚。必须在 **布局 (Layout)** 上把图表容器切分为“左侧 95% (历史)” + “右侧 5% (实时)” 两个独立的 DOM 容器。

   * **实现**：使用 Flex 布局，左边放 Recharts 历史图，右边放一个独立的 `div` 或小 Recharts 来专门展示实时状态（呼吸点 + 数值）。

2. **真实价格源问题**：

   * 用户强调“拉到什么就是什么，不要前端修复，如果是错的就去改源头”。

   * **问题定位**：截图显示价格最后暴跌。这说明后端 `monitor.py` 在获取或解析腾讯数据时，最后一次 Tick 的价格字段解析出了问题（可能是 0 或 异常值）。

   * **动作**：必须深入检查 `backend/app/services/monitor.py` 中的解析逻辑，特别是针对腾讯接口返回数据的索引 `parts[3]` 是否稳定，以及是否因为休市/收盘后的数据格式变化导致解析错误。

## 2. 实施方案

### A. 后端修复 (`monitor.py`)

* **排查价格解析**：在 `_tick` 函数中，打印最后一次解析的 `price`。如果 `parts[3]` 异常，检查 `parts` 的长度和内容。

* **收盘处理**：如果当前时间超过 15:00，应停止更新或保持最后收盘价，防止抓取到无效数据（如盘后竞价或清算数据导致的 0 值）。

### B. 前端重构 (`SentimentTrend.tsx`) —— **物理分割**

* **布局重构**：

  ```tsx
  <div className="flex h-full w-full">
    {/* 左侧：95% 历史走势区 */}
    <div className="flex-1 border-r border-slate-700">
       <AreaChart ... data={historyData} />
    </div>
    
    {/* 右侧：5% 实时独立区 */}
    <div className="w-[60px] flex flex-col items-center justify-center bg-slate-900/80 relative">
       <div className="absolute inset-0 border border-yellow-500/30 animate-pulse" /> {/* 边框 */}
       {/* 呼吸点与实时数值 */}
       <div className="text-yellow-400 font-bold">{livePrice}</div>
       <div className={`w-3 h-3 rounded-full ${liveCvd > 0 ? 'bg-red-500' : 'bg-green-500'} animate-ping`} />
    </div>
  </div>
  ```

* **移除白线**：设置 Area `stroke="none"`。

* **价格线**：左侧图表只画历史价格线。右侧直接显示数字。

## 3. 执行步骤

1. **后端**：检查并修复 `monitor.py` 中价格解析的潜在 Bug（增加日志，增加非交易时间过滤）。
2. **前端**：彻底重写 `SentimentTrend.tsx` 的渲染结构，将图表拆分为“历史图”和“实时面板”左右两部分。

此方案完全响应了用户“独立区域框出来”和“源头修正价格”的要求。
