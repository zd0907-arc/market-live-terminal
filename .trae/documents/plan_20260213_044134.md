# V3.0 资金博弈分析模块 - 系统优化方案设计文档

## 1. 核心目标
本方案旨在落实“小白化”、“风险提示”与“高性能”三大目标，通过重构信号定义、数据流转架构与前端交互，打造即懂即用的实战工具。

## 2. 信号重构与算法定义 (Signal Engineering)

### 2.1 信号映射表 (Schema Update)
不再直接存储原始技术指标，而是存储“合成信号”。

| 信号ID | 前端展示名 | 触发逻辑 (Python伪代码) | 过滤条件 |
| :--- | :--- | :--- | :--- |
| `AGGRESSIVE_BUY` | **🔥 主力抢筹** | `Iceberg_Sell` AND `Price_Change >= 0` AND `CVD_Delta > 0` | `Trade_Vol > 100万` |
| `HEAVY_PRESSURE` | **🧱 抛压沉重** | `Iceberg_Sell` AND `Price_Change <= 0` AND `CVD_Delta <= 0` | `Trade_Vol > 100万` |
| `EXHAUSTION` | **⚠️ 进攻力竭** | `Prev_Min_Signal == AGGRESSIVE_BUY` AND `Curr_Min_CVD_Slope <= 0` | 无 |
| `ICEBERG_RAW` | (隐藏) | `Iceberg_Sell` | 前端不渲染 |

### 2.2 算法实现 (`backend/app/services/monitor.py`)
需要修改 `check_iceberg_sell` 等函数，增加上下文判断（结合价格和CVD趋势）。

```python
def check_composite_signal(prev, curr):
    # 基础信号
    iceberg = check_iceberg_sell(prev, curr)
    
    # 价格与资金趋势
    price_up = curr['price'] >= prev['price']
    cvd_up = (curr['outer_vol'] - curr['inner_vol']) > (prev['outer_vol'] - prev['inner_vol'])
    amount = curr['amount'] - prev['amount'] # 需新增 amount 字段追踪

    if iceberg and amount > 1000000: # 100万阈值
        if price_up and cvd_up:
            return "AGGRESSIVE_BUY"
        elif not price_up and not cvd_up:
            return "HEAVY_PRESSURE"
    return None
```

## 3. 数据架构重构 (Architecture & Performance)

采用 **“历史归档 (Archive) + 实时推送 (Live)”** 双轨制。

### 3.1 数据库变更 (`backend/app/db/database.py`)
1.  **修正 Schema**: 确认 `sentiment_snapshots` 表包含 `signals` 字段 (TEXT/JSON)。
2.  **无需新表**: 历史分钟级数据可通过 SQL 聚合实时生成，避免数据冗余。

### 3.2 接口改造 (`backend/app/routers/market.py`)

#### A. 历史归档接口 `GET /api/market/sentiment/history?symbol=sh600000`
*   **逻辑**: 按 `strftime('%Y-%m-%d %H:%M', timestamp)` 分组聚合。
*   **返回**:
    ```json
    [
      {
        "time": "09:30",
        "cvd": 50020,        // 该分钟最后一笔的CVD
        "oib": 1200,         // 该分钟OIB的平均值
        "price": 23.50,      // 收盘价
        "signals": ["AGGRESSIVE_BUY"] // 该分钟内出现过的最强信号
      },
      ...
    ]
    ```

#### B. 实时流接口 `WS /ws/market/sentiment/{symbol}`
*   **频率**: 维持 3秒/次。
*   **内容**: 推送当前分钟内的“增量”或“最新切片”。
*   **前端处理**: 
    *   前端维护一个 `currentMinuteBuffer` 数组。
    *   每收到 3秒数据，推入 Buffer，更新图表最右侧的“跳动点”。
    *   当时间跨越分钟 (如 09:31:00)，将 Buffer 归档进 History，清空 Buffer。

## 4. 前端交互设计 (`src/components/dashboard/SentimentTrend.tsx`)

### 4.1 可视化组件 (Recharts)
*   **数据源**: `[...historyData, currentLivePoint]`
*   **呼吸点 (Pulsing Dot)**:
    *   使用 `ReferenceDot` 或自定义 `CustomizedDot`。
    *   CSS 动画: `@keyframes pulse { 0% { r: 3; opacity: 1; } 100% { r: 6; opacity: 0; } }`。
    *   颜色: 动态绑定 (`cvd_delta > 0 ? red : green`)。

### 4.2 智能文案 Tooltip
重写 `CustomTooltip` 组件，支持 HTML 渲染。

```tsx
const getTooltipContent = (payload) => {
  if (payload.signal === 'AGGRESSIVE_BUY') {
    return (
      <div className="p-2 bg-gray-900 border-l-4 border-red-500">
        <h4 className="text-red-500 font-bold">🔥 主力抢筹</h4>
        <p className="text-white">现象：巨额压单被暴力吃掉，价格不跌反涨。</p>
        <p className="text-gray-400 text-xs mt-1">⚠️ 风险：若CVD后续走平，警惕假突破。</p>
      </div>
    );
  }
  // ... 其他场景
};
```

## 5. 执行计划 (Action Plan)

1.  **后端**:
    *   修改 `database.py` 确保 `signals` 字段存在。
    *   修改 `monitor.py` 实现 V3.0 信号逻辑 (抢筹/抛压/过滤)。
    *   实现 `GET /history` 聚合逻辑。
2.  **前端**:
    *   改造 `SentimentTrend` 组件，分离 History 和 Realtime 状态。
    *   实现呼吸点动画。
    *   实现三段式 Tooltip。
3.  **验证**:
    *   使用模拟数据触发“主力抢筹”信号，验证 UI 展示和文案准确性。

**待确认事项**:
是否立即开始执行此方案？我们将优先进行数据库检查和后端信号逻辑的更新。