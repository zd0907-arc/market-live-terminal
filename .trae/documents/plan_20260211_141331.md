# 后续开发规划：逻辑统一与架构升级 (Phase 2 & 3)

根据您提供的原始计划及当前代码状态分析，虽然我们完成了 P0（前端组件拆分），但核心的 **逻辑一致性** 和 **后端架构** 问题尚未解决，且存在高危的“逻辑分裂”风险（前端阈值 50万 vs 后端 20万）。

以下是接下来的详细执行规划：

---

## 阶段一：逻辑统一与数据契约 (Logic Unification) - P1
**目标**: 消除“前后端各算各的”导致的逻辑分裂，确保阈值和算法一致。

1.  **统一配置源**:
    *   **后端 API**: 在 `server.py` 增加 `/api/config/public` 接口，暴露当前的 `large_threshold`（大单阈值）等核心参数。
    *   **前端适配**: 修改 `RealtimeView.tsx`，移除硬编码的 `const MAIN_FORCE_THRESHOLD = 500000`。改为组件初始化时从后端拉取配置，确保实时计算标准与后端历史计算标准完全一致。
2.  **算法抽离 (前端侧)**:
    *   创建 `src/utils/calculator.ts`，将 `recalcChartData` 中的聚合逻辑提取为纯函数。
    *   这样未来如果要校验逻辑，只需对比 Python 的聚合函数和这个 TS 函数。

## 阶段二：后端架构重构 (Backend Refactoring) - P2
**目标**: 拆解 `server.py` 单体文件，建立清晰的分层架构，便于维护和扩展。

1.  **目录结构初始化**:
    *   创建 `backend/` 目录，建立以下子模块：
        *   `backend/app/main.py`: FastAPI 入口。
        *   `backend/app/api/`: 存放路由 (Router)，如 `market.py`, `config.py`。
        *   `backend/app/services/`: 业务逻辑层，存放 `DataCollector` (爬虫) 和 `Calculator` (资金计算)。
        *   `backend/app/db/`: 数据库连接与模型定义。
2.  **逻辑迁移**:
    *   将 `server.py` 中的数据库初始化代码移至 `backend/app/db/database.py`。
    *   将爬虫线程 `DataCollector` 移至 `backend/app/services/collector.py`。
    *   将 API 路由拆分并迁移。

## 阶段三：服务层与类型安全 (DAO & Types) - P3
**目标**: 解决 `parts[30]` 这种脆弱的硬编码问题。

1.  **后端数据模型**:
    *   在后端定义 Pydantic Model (如 `TickData`, `MarketQuote`)，API 返回标准 JSON 而非原始数组。
2.  **前端适配**:
    *   更新 `stockService.ts`，对接新的后端数据结构。

---

## 立即执行步骤 (Immediate Next Steps)

鉴于您希望“不要经常把不该改的地方改坏了”，我建议**先完成 P1 (逻辑统一)**，因为这是目前最大的业务风险点。

**本轮任务清单 (Todo List):**
1.  **Backend**: 在 `server.py` 中添加获取公开配置的 API。
2.  **Frontend**: 修改 `RealtimeView.tsx`，实现动态阈值加载，替换硬编码的 50万 阈值。
3.  **Frontend**: 将核心计算逻辑抽离到 `src/utils/calculator.ts`。
4.  **Verification**: 验证实时图表的主力资金线是否与修改后的阈值产生联动。

您是否同意先执行 P1 阶段任务？
