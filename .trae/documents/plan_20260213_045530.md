# V3.0 资金博弈分析模块 - 错误修复方案

## 1. 问题分析 (Root Cause Analysis)

用户反馈了两个问题：

1. **控制台报错**: `Received NaN for the %s attribute... offset`。

   * **原因**: 前端 `SentimentTrend.tsx` 中的 `gradientOffset` 函数在数据为空或极值异常（如 max=min）时计算出 `NaN`，导致 SVG 渲染错误。
2. **模块无信息**: 资金博弈模块未显示数据。

   * **原因**: 后端代码虽然已更新，但之前的服务进程未重启，导致新加的 `/api/sentiment/history` 接口未生效（之前的日志显示 404）。

## 2. 解决方案 (Solution)

### A. 后端服务 (Backend)

* **动作**: 已在后台重启了后端服务 (Terminal 4)。

* **验证**: 日志显示 `Registered Route: /api/sentiment/history [{'GET'}]`，证明新接口已生效。

### B. 前端代码 (Frontend)

需要修改 `src/components/dashboard/SentimentTrend.tsx` 增强健壮性，防止 NaN 错误。

1. **修复 NaN 问题**:
   修改 `gradientOffset` 函数，增加边界检查：

   ```typescript
   const gradientOffset = () => {
     if (data.length === 0) return 0;
     const max = Math.max(...data.map(i => i.cvd));
     const min = Math.min(...data.map(i => i.cvd));
     if (max <= 0) return 0;
     if (min >= 0) return 1;
     // 防止除以零
     if (max === min) return 0; 
     return max / (max - min);
   };
   ```

2. **防止闪烁**:
   在数据加载前提供默认空状态，避免渲染空数组导致的计算错误。

##
