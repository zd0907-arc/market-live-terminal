# 主力动态数据本地化重构方案 (v2)

感谢您的反馈。确实，3分钟的频率对于“主力动向”分析已经足够，且能大幅降低系统资源占用。我们将优先提交当前版本，然后开始新一轮开发。

## 1. 版本提交 (Pre-requisite)
在开始新开发前，我们将先把“多空情绪仪表盘 (v2.2.0)”相关代码提交到 Git。
*   操作：更新版本号至 `2.2.1`，提交到 feature 分支。

## 2. 核心重构计划

### 2.1 频率与体验优化
*   **频率调整**：后台采集器频率调整为 **3分钟/次** (180秒)。
    *   这是一个非常舒适的节奏，既不会错过主力大单，又不会对您的网络和 CPU 造成负担。
*   **用户体验 (UX)**：
    *   前端 `RealtimeView` 将增加一个明显的 **“数据更新时间”** 标记（例如：`Last updated: 13:45:00`）。
    *   前端读取本地数据库是毫秒级的，因此您会感觉到“秒开”。
    *   后台默默更新时，前端不会有任何转圈或卡顿。当后台完成写入，前端下一次轮询（例如每 10秒 查一次库）发现时间变了，就会自动刷新界面。

### 2.2 数据库重构 (Schema Migration)
*   **动作**：**丢弃** 旧的 `trade_ticks` 表，重建新表。
*   **变更**：
    *   **移除 UNIQUE 约束**：这是为了解决“同分同秒同价同量”交易被误删的 Bug。
    *   **索引优化**：为 `(symbol, date)` 建立联合索引，确保每次“全量覆盖”时的 DELETE 操作瞬间完成。

### 2.3 开发步骤 (Implementation Steps)
1.  **DB层**：修改 `init_db` 重建表结构；修改 `crud.py` 实现 `save_ticks_daily_overwrite`（事务覆盖写入）。
2.  **Service层**：修改 `collector.py`，将休眠时间设为 180秒，并调用新的写入方法。
3.  **API层**：修改 `/api/ticks_full`，改为纯粹读取数据库，不再触发实时爬虫。
4.  **Frontend层**：在 `RealtimeView` 顶部增加更新时间显示，并优化轮询逻辑（只查库）。

如果确认无误，我将首先执行 Git 提交，然后开始重构。