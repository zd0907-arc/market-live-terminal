# 后续执行计划：后端架构重构 (Phase 2 & 3)

既然 P1 (逻辑统一) 已经完成，我们现在进入 **P2 (后端架构重构)** 和 **P3 (类型安全)** 的合并执行阶段。我们的目标是将单文件 `server.py` 拆解为标准的、可维护的 Python 后端项目结构，并修复潜在的依赖问题。

---

## 任务一：依赖修复 (Fix Dependencies) - P0
**目标**: 确保项目环境可复现，防止部署失败。
1.  **更新 `requirements.txt`**: 
    *   添加 `akshare` (关键缺失)。
    *   添加 `pandas` (关键缺失)。
    *   添加 `httpx` (推荐替代 requests，支持异步，虽然目前用 requests 也可以，但建议记录)。

## 任务二：后端目录结构重组 (Directory Restructure) - P2
**目标**: 将 `server.py` 拆分为职责单一的模块。

1.  **创建目录结构**:
    ```text
    backend/
    ├── app/
    │   ├── __init__.py
    │   ├── main.py          <-- 新的入口文件 (原 server.py 的入口部分)
    │   ├── core/            <-- 核心配置
    │   │   └── config.py
    │   ├── db/              <-- 数据库层
    │   │   ├── database.py  <-- 数据库连接与初始化 (原 init_db)
    │   │   └── crud.py      <-- 数据库操作 (SQL 语句封装)
    │   ├── services/        <-- 业务逻辑层
    │   │   ├── collector.py <-- 原 DataCollector 类
    │   │   ├── market.py    <-- 新浪/腾讯/东财 API 调用逻辑
    │   │   └── analysis.py  <-- 原 aggregate_history 核心算法
    │   ├── routers/         <-- API 路由层
    │   │   ├── watchlist.py
    │   │   ├── market.py    <-- 实时数据相关接口
    │   │   └── analysis.py  <-- 历史分析相关接口
    │   └── models/          <-- Pydantic 模型 (P3 准备)
    │       └── schemas.py
    ```

## 任务三：代码逻辑迁移 (Logic Migration) - P2
**目标**: 将 `server.py` 的代码无损迁移到新结构。

1.  **迁移数据库逻辑**: 将 `sqlite3` 相关代码移至 `backend/app/db/`。
2.  **迁移爬虫服务**: 将 `DataCollector` 类移至 `backend/app/services/collector.py`。
3.  **迁移业务逻辑**: 将 `get_sina_money_flow` 等函数移至 `backend/app/services/market.py`。
4.  **拆分路由**: 将 `@app.get` 装饰的函数拆分到 `backend/app/routers/` 下的对应文件，并使用 `APIRouter` 注册。

## 任务四：引入类型安全 (Type Safety) - P3
**目标**: 消除 `row[0]` 和手动字典拼接，提高代码健壮性。

1.  **定义 Pydantic 模型**:
    *   在 `backend/app/models/schemas.py` 中定义 `TradeTick`, `AnalysisResult`, `APIResponse` 等模型。
2.  **应用模型**:
    *   修改路由函数的返回类型注解 (Response Model)，让 FastAPI 自动处理数据校验和序列化。

---

## 立即执行步骤 (Immediate Next Steps)

为了保持节奏，我建议将 P2 和 P3 合并执行，因为在拆分文件的同时顺便加上类型定义是最最高效的。

**本轮 Todo List:**
1.  **Setup**: 创建 `backend/app` 目录结构，更新 `requirements.txt`。
2.  **DB Layer**: 迁移数据库初始化与连接逻辑。
3.  **Service Layer**: 迁移 `DataCollector` 和市场数据获取逻辑。
4.  **Router Layer**: 拆分并迁移 API 路由，同时应用 Pydantic 模型。
5.  **Entry Point**: 创建新的 `main.py` 并组装所有模块。
6.  **Cleanup**: 删除旧的 `server.py`（在确认新服务运行正常后）。

您是否同意开始执行后端重构？
