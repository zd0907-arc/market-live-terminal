# 修复 Sentiment 模块运行错误及超时机制

您遇到的“秒出报错” (Instant Network Error) 根本原因在于 **后端代码存在严重的导入错误**，导致 API 被调用时直接崩溃或无法正确响应。虽然 `test-llm` 能通（因为它在 `config` 路由），但 `sentiment` 路由下的所有接口（Trend, Summary）都会因为代码错误而失败。

## 1. 发现的问题 (Critical Bugs)

通过代码审查，我在 `backend/app/routers/sentiment.py` 中发现了以下会导致运行时崩溃的错误：

1.  **缺少 `APIResponse` 导入**: 代码中试图返回 `APIResponse` 对象，但头部未导入该类。这将导致 `NameError`。
2.  **`datetime` 使用错误**: 代码使用了 `import datetime`，但在调用时直接用了 `datetime.now()`（应该是 `datetime.datetime.now()`），且使用了未导入的 `timedelta`。这将导致 `AttributeError` 和 `NameError`。

这些错误会导致后端在接收到请求的瞬间抛出异常，进而导致前端请求失败。

## 2. 修复计划 (Step-by-Step)

我将执行以下操作来彻底修复此问题：

### **第一步：修复 `sentiment.py` 代码错误**
*   **添加导入**: 从 `backend.app.models.schemas` 导入 `APIResponse`。
*   **修正时间处理**: 修改为 `from datetime import datetime, timedelta`，确保 `datetime.now()` 和 `timedelta` 可正常使用。

### **第二步：优化超时设置 (防止修复后出现超时)**
既然已经在这个环节，我将一并解决之前提到的潜在超时问题，确保修复代码后 AI 总结能顺利跑通：
*   **后端**: 将 `llm_service.py` 的请求超时从 30s 增加到 **60s**。
*   **前端**: 将 `sentimentService.ts` 的 Axios 超时从 60s 增加到 **120s**。

### **第三步：增强前端容错**
*   **Dashboard**: 优化错误提示，如果遇到 Network Error，明确提示可能是后端服务异常或网络中断。

## 3. 预期结果
执行上述修复后：
1.  `/api/sentiment/*` 接口将恢复正常，不再秒崩。
2.  AI 总结功能将能够正常调度大模型，且有足够的时间等待生成结果。

请确认执行此修复计划。