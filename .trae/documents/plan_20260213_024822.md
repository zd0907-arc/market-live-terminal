# 散户情绪模块自动抓取与交互优化计划

针对您提出的“手动抓取从未成功”及“增加后台自动抓取”的需求，制定以下实施计划：

## 1. 后端：增加每日自动抓取任务 (Backend Scheduler)
目前系统仅在添加自选股时触发一次抓取。我们将利用现有的 `APScheduler` 增加定时任务，确保自选股（星标股）的数据在后台自动更新。

*   **修改文件**: `backend/app/scheduler.py`
*   **新增功能**: `run_daily_sentiment_crawl` 函数。
*   **逻辑**:
    1.  调用 `get_watchlist_items()` 获取所有关注股票。
    2.  遍历列表，对每个股票调用 `sentiment_crawler.run_crawl(symbol)`。
    3.  设置定时触发器（例如每天 08:00 或每隔 4 小时）。
*   **目的**: 确保“深度抓取”（14天历史）在后台静默完成，用户打开时只需进行“增量抓取”。

## 2. 后端：API 改为同步等待模式 (Synchronous API)
目前 `/crawl/{symbol}` 接口使用 `BackgroundTasks` 立即返回，导致前端在抓取完成前就刷新数据，从而看不到新内容。

*   **修改文件**: `backend/app/routers/sentiment.py`
*   **修改内容**:
    *   移除 `BackgroundTasks`。
    *   使用 `starlette.concurrency.run_in_threadpool` 包装爬虫调用，使其在后台线程运行但**等待结果**。
    *   返回抓取到的新增条数 `new_count`。
*   **效果**: 前端请求会一直转圈等待，直到爬虫真正执行完毕（增量抓取通常只需几秒）才返回，确保数据一致性。

## 3. 前端：优化交互与反馈 (Frontend UX)
配合后端变更，优化前端等待逻辑，不再使用死板的 3 秒倒计时。

*   **修改文件**: `src/components/sentiment/SentimentDashboard.tsx`
*   **优化点**:
    1.  **移除 `setTimeout`**: 改为 `await sentimentService.crawl(symbol)`，真正等待后端完成。
    2.  **状态提示**: 当点击抓取时，显示“正在同步最新评论...”。
    3.  **最后更新时间**: 在界面右上角增加“上次更新：刚刚/xx分钟前”的提示（基于数据中最新的 `crawl_time` 或 `pub_time`）。
    4.  **容错处理**: 如果抓取超时（针对首次深度抓取），提示用户“后台正在进行深度抓取，请稍后刷新”。

## 4. 验证与测试
1.  **自动抓取**: 手动触发一次调度任务，验证日志中是否遍历了 Watchlist。
2.  **手动抓取**: 打开一个已在 Watchlist 的股票，点击抓取，验证是否在 2-5 秒内完成并刷新出最新几分钟内的评论。
3.  **新股测试**: 添加一个不在 Watchlist 的新股，点击抓取，验证界面是否提示“正在抓取”并最终（可能需几十秒）显示数据，或提示超时但后台仍在运行。
