# V3.0 深度优化方案设计文档

## 1. 核心目标
本方案旨在解决两大痛点：
1.  **右侧实时区信息密度不足**：将其升级为“微观听诊器”，充分利用腾讯 3秒快照数据，直观展示多空博弈。
2.  **OIB 柱状图比例失调**：因个别极大值（如 7.5w 手）导致正常波动被压缩成直线，需引入“智能截断”机制。

## 2. 详细设计

### 第一部分：右侧实时面板 (Right Panel) - “微观听诊器”
此区域垂直贯穿整个资金博弈模块右侧（约 60px 宽），分为上、中、下三层。

#### A. 顶层：瞬时价格与动能 (Instant Price & Momentum)
*   **显示内容**：大字号当前价格（如 `23.75`）。
*   **交互逻辑**：
    *   比较 `Current_Price` 与 `Last_Price`（内存中缓存上一次 tick）。
    *   **涨**：背景闪烁微红光 (`bg-red-500/20` -> `transparent` 动画)。
    *   **跌**：背景闪烁微绿光。
    *   **平**：无背景色。
*   **数据源**：`liveData.price`。

#### B. 中层：多空对峙条 (Bid-Ask Ratio)
*   **核心逻辑**：买一 vs 卖一的实时对抗。
*   **UI 设计**：
    *   垂直进度条 (Height: ~100px, Width: 8px)。
    *   **上段 (卖压)**：绿色，高度占比 = `Ask1 / (Bid1 + Ask1)`。
    *   **下段 (买托)**：红色，高度占比 = `Bid1 / (Bid1 + Ask1)`。
    *   **游标**：中间白色细线，随比例上下移动。
    *   **数值**：顶部显示 `压:5000` (绿色小字)，底部显示 `托:2000` (红色小字)。
*   **数据源**：需扩展 `monitor.py` 和 API，将 `bid1_vol` 和 `ask1_vol` 传递给前端。

#### C. 底层：Tick 速度 (Tick Velocity)
*   **核心逻辑**：这 3秒内成交了多少手。
*   **计算公式**：`Tick_Vol = Current_Total_Vol - Last_Total_Vol`。
*   **UI 显示**：
    *   `Tick: 85`。
    *   **高亮**：若 `Tick_Vol > 1000` (或动态阈值)，显示 ⚡️ 图标并变黄。
*   **数据源**：需扩展后端逻辑，计算差值并传递 `tick_vol`。

---

### 第二部分：OIB 柱子优化 - “智能截断” (Smart Truncation)
*   **问题**：7.5w 的柱子压扁了 2k 的柱子。
*   **算法逻辑**：
    1.  **计算阈值**：取所有 OIB 绝对值的 **98分位** 或 **平均值 × 3**（例如算出来是 1.5w）。
    2.  **数据预处理**：
        ```javascript
        const LIMIT = 15000;
        data.map(d => {
            if (Math.abs(d.oib) > LIMIT) {
                return {
                    ...d,
                    oib_display: d.oib > 0 ? LIMIT : -LIMIT, // 截断值用于画图
                    oib_real: d.oib,                         // 真实值用于 Tooltip
                    is_clipped: true                         // 标记
                };
            }
            return { ...d, oib_display: d.oib, oib_real: d.oib, is_clipped: false };
        })
        ```
*   **可视化实现 (Recharts)**：
    *   使用 `Cell` 组件自定义颜色。
    *   **被截断的柱子**：
        *   颜色变淡 (Opacity 0.6) 或顶部加虚线边框。
        *   使用 `<LabelList />` 或自定义 `Content` 在柱子上方/下方直接显示真实数值（如 `7.5w`）。
    *   **普通柱子**：不显示数值，保持清爽。

---

## 3. 技术实现步骤

### Step 1: 后端改造 (`monitor.py` & `schemas.py`)
1.  **扩展数据结构**：在 `Snapshot` 中增加 `bid1_vol`, `ask1_vol`, `tick_vol`。
2.  **计算逻辑**：
    *   `tick_vol` 需要缓存上一次的 `total_volume` 来计算差值。
    *   将这些新字段存入数据库 `sentiment_snapshots` 表（或仅在内存/Redis中用于实时推送，历史数据可暂不存 Tick 细节，仅存聚合）。*决策：为了回放，建议存入数据库 JSON 字段或扩展列。鉴于这是 V3.0，先通过 `signals` 字段或新增列存储。*
    *   **简化方案**：实时接口直接返回这些字段，历史接口若无数据则置 0。

### Step 2: 数据库迁移
*   给 `sentiment_snapshots` 表增加 `bid1_vol`, `ask1_vol` 字段（`tick_vol` 可实时计算或存储）。
*   *快速方案*：利用现有的 `signals` JSON 字段存储额外信息，避免改表结构。或者直接改表，比较稳妥。
*   **决定**：修改 `monitor.py`，将 `bid1_vol`, `ask1_vol` 写入数据库。

### Step 3: 前端 OIB 截断实现 (`SentimentTrend.tsx`)
1.  计算 `truncateThreshold`。
2.  生成 `chartData` 时增加 `oib_display` 等字段。
3.  修改 `<BarChart>`，绑定 `oib_display`。
4.  添加 `<LabelList>`，仅对 `is_clipped` 为 true 的数据展示 `oib_real`。

### Step 4: 前端右侧面板重写
1.  实现三个子组件：`InstantPrice`, `BidAskGauge`, `TickVelocity`。
2.  对接新的实时数据字段。

## 4. 交付物
*   更新后的设计文档。
*   修改后的 `monitor.py` (后端)。
*   修改后的 `SentimentTrend.tsx` (前端)。
*   数据库迁移脚本 (如有必要)。
