# 配置保存功能修复计划

ConfigModal 配置保存失败的原因是前端使用 URL 参数传递配置，且未进行编码，而后端期望 JSON Body，同时后端 Pydantic 模型 `AppConfig` 与实际接收的键值对结构不匹配。这将导致 422 验证错误，且特殊字符（如 URL 中的 `://`）会导致请求路径错误。

## 1. 后端修复 (Backend Fixes)

### 1.1 新增通用配置更新模型
*   **文件**: `backend/app/models/schemas.py`
*   **操作**: 新增 `ConfigUpdate` Pydantic 模型，包含 `key` 和 `value` 字段，专门用于配置更新接口。

### 1.2 修改配置更新接口
*   **文件**: `backend/app/routers/config.py`
*   **操作**:
    *   将 `update_config` 的入参类型从 `AppConfig` 修改为 `ConfigUpdate`。
    *   这样后端就能正确解析前端传来的 `{key: "...", value: "..."}` 格式的 JSON Body。

## 2. 前端修复 (Frontend Fixes)

### 2.1 修正 API 调用方式
*   **文件**: `src/services/stockService.ts`
*   **操作**:
    *   修改 `updateAppConfig` 函数。
    *   不再将参数拼接在 URL 中 (`?key=...&value=...`)。
    *   改为发送标准的 JSON Body (`JSON.stringify({ key, value })`)。
    *   添加 `Content-Type: application/json` 请求头。

## 3. 验证计划
1.  **保存测试**: 打开配置弹窗，修改 `large_threshold`，点击保存，检查网络请求是否为 200 OK。
2.  **特殊字符测试**: 修改 LLM Base URL 为 `https://api.openai.com/v1`，点击保存，验证是否不再报错。
3.  **持久化验证**: 刷新页面，检查配置是否依然存在（即 `.env.local` 是否被正确更新）。
