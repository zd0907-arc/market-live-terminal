## 修复与优化方案

根据您的要求和反馈，我将从“数据准确性”和“架构性能”两个维度进行深度优化。

### 1. 架构升级：后端主导计算 (Server-Side Aggregation)
针对“加载慢”和“前端计算不准”的问题，彻底重构数据流。前端不再接收数万条原始 Ticks，改为接收后端计算好的分钟级趋势数据。

*   **新增后端计算服务 (`backend/app/services/analysis.py`)**：
    *   移植原前端 TypeScript 的 `calculateCapitalFlow` (分时博弈) 和 `calculateCumulativeCapitalFlow` (累计资金) 逻辑到 Python。
    *   使用 Pandas 高效处理数据聚合，生成分钟级（1min）或更细粒度的图表数据。
*   **新增 API 端点 (`GET /api/realtime/dashboard`)**：
    *   一次性返回 `chart_data` (全天趋势) 和 `latest_ticks` (最新的20-50笔明细用于列表展示)。
    *   响应体积将从几 MB 骤降至几 KB，秒开无压力。
*   **前端改造 (`RealtimeView.tsx`)**：
    *   移除所有本地计算逻辑。
    *   直接渲染后端返回的图表数据。
    *   仅展示后端返回的最新几笔 Ticks，不再维护全量 Ticks 数组。

### 2. 数据准确性修复 (Fix 15:00+ Ghost Data)
针对“收盘后仍有数据更新”和“时间轴错误”的问题：

*   **严格限制采集时间 (`collector.py`)**：
    *   在 `_is_trading_time` 中增加硬性熔断：`15:05` 后强制停止任何数据写入（留5分钟给收盘竞价数据）。
    *   在写入数据库前，过滤掉 `time > 15:00:05` 的脏数据（防止数据源本身的时间戳漂移）。
*   **API 输出过滤**：
    *   后端在返回数据时，再次清洗，剔除 `15:00` 之后的时间点，确保图表横轴标准。
*   **Mock 数据修正**：
    *   检查是否有测试代码在非交易时间生成了当前时间戳的模拟数据，确保使用 Mock 日期（如 `MOCK_DATA_DATE`）时时间戳也符合历史逻辑。

### 3. 数据同步与去重
针对“按秒同步可能丢数据”的担忧：

*   **全量状态快照 (Snapshot Strategy)**：
    *   由于图表数据量极小（240分钟 x 几个指标），后端每次直接返回**截止当前的完整图表数据**。
    *   前端每次全量替换图表，完全避免了“增量同步漏数据”或“重复计算”的问题。
    *   对于 Ticks 列表，仅返回最新的 N 条，不做全量拼接，仅做展示。

### 执行步骤
1.  **后端**：实现 `calculate_realtime_aggregation` 函数，移植资金流计算逻辑。
2.  **后端**：创建 `/api/realtime/dashboard` 接口，整合图表数据与最新明细。
3.  **后端**：修改 `collector.py`，增加 `15:05` 强制停止和脏数据过滤逻辑。
4.  **前端**：重构 `RealtimeView`，接入新接口，删除旧的计算代码。
