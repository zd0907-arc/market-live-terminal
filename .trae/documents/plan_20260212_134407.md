# 散户情绪模块 (Retail Sentiment) 开发计划

## 1. 需求分析与设计文档
首先，我们将根据您的对话内容，整理并创建一份详细的需求设计文档 `docs/retail_sentiment_design.md`。

### 核心功能 (MVP)
1.  **数据源**: 东方财富股吧 (Eastmoney Guba)。
2.  **数据清洗**: 
    *   去除广告/无效贴。
    *   **情感打分**: 基于关键词字典 (Dict-based) 计算单条评论情感分 (-1/0/1)。
    *   **热度计算**: 基于阅读量和评论量的加权公式。
3.  **存储**: SQLite 本地数据库，支持增量更新。
4.  **分析**: 
    *   统计指标: 情绪声浪 (Buzz Volume)、多空比 (Bull/Bear Ratio)。
    *   **LLM 总结**: 选取高热度/代表性评论，通过 Prompt 生成定性评价 (Score, Status, Summary, Risk)。
5.  **UI 展示**: 
    *   仪表盘: 情绪得分、当前状态、多空比。
    *   图表: 情绪热度趋势图 (Line Chart)。
    *   摘要: AI 生成的文字总结和风险提示。

## 2. 后端开发 (Backend)
### 数据库设计
*   **表名**: `sentiment_comments`
*   **字段**: 
    *   `id` (主键, 唯一标识)
    *   `stock_code` (股票代码)
    *   `content` (评论内容)
    *   `pub_time` (发布时间)
    *   `read_count` (阅读数)
    *   `reply_count` (回复数)
    *   `sentiment_score` (情感分: -1, 0, 1)
    *   `heat_score` (热度分)
    *   `crawl_time` (抓取时间)

### 服务层 (Services)
1.  **爬虫服务 (`services/sentiment_crawler.py`)**:
    *   实现对东方财富股吧的页面抓取与解析。
    *   支持增量抓取 (基于 `pub_time` 过滤已存数据)。
2.  **分析服务 (`services/sentiment_analyzer.py`)**:
    *   实现 `StockSentimentCleaner` 类: 包含黑话词典、情感打分逻辑、热度计算逻辑。
    *   实现 `LLMAnalyst` 类: 构造 Prompt，调用 LLM (或模拟) 生成总结。
3.  **API 接口 (`routers/sentiment.py`)**:
    *   `POST /api/sentiment/crawl/{symbol}`: 触发指定股票的评论抓取与分析。
    *   `GET /api/sentiment/dashboard/{symbol}`: 获取仪表盘所需的聚合数据 (今日评分、多空比、AI总结)。
    *   `GET /api/sentiment/trend/{symbol}`: 获取历史趋势数据 (用于画图)。

## 3. 前端开发 (Frontend)
### 组件设计
1.  **数据服务 (`src/services/sentimentService.ts`)**:
    *   封装后端 API 调用。
2.  **仪表盘组件 (`src/components/sentiment/SentimentDashboard.tsx`)**:
    *   展示核心指标 (Score, Status, Ratio)。
    *   展示 AI 总结 (Summary, Risk Warning)。
3.  **趋势图组件 (`src/components/sentiment/SentimentTrendChart.tsx`)**:
    *   使用 Recharts 绘制“情绪热度”与“多空比”的时间序列图。
4.  **集成**:
    *   在 `src/App.tsx` 或顶部信息栏下方引入 `SentimentDashboard`，实现输入股票代码后自动刷新。

## 4. 任务执行步骤
1.  **创建文档**: 编写 `docs/retail_sentiment_design.md`。
2.  **后端实现**: 
    *   更新 `db/crud.py` 初始化数据表。
    *   实现 Crawler 和 Analyzer 服务。
    *   创建 API 路由并注册到 `main.py`。
3.  **前端实现**:
    *   创建 API Service。
    *   开发 Dashboard 和 TrendChart 组件。
    *   集成到主界面。
4.  **联调与测试**:
    *   以 "000833" (粤桂股份) 为例进行测试，验证数据抓取、清洗、存储及展示流程。
