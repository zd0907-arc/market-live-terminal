# 历史资金趋势功能设计与自动化改造方案

## 1. 系统机制优化 (System Optimization)

### A. 实时接口与模拟功能
*   **现状确认**: 目前系统通过持续轮询 AkShare 接口来实现“实时”。收盘后继续轮询确实会不断拉取相同的全量静态数据，这构成了您提到的“模拟”效果。
*   **优化建议**: **不需要**专门的模拟功能开关。
    *   **理由**: 只要数据在收盘时（15:05）成功入库一次，它就持久化在 SQLite 中了。收盘后继续开发时，前端直接读取数据库即可，无需后台持续空转轮询。
    *   **动作**: 修改 `collector.py`，增加交易时间判断（如 09:00-15:15），非交易时间自动停止高频轮询，降低系统开销。

### B. 自动化收盘清洗 (Scheduler)
*   **方案**: 引入 `APScheduler` 定时任务库。
*   **动作**: 
    1.  安装 `APScheduler`。
    2.  在后端启动时初始化调度器。
    3.  配置 `Cron` 任务：每天 **15:05** 自动执行“收盘清洗”作业（即之前的 `finalize_data` 逻辑）。

## 2. 历史资金趋势升级 (Historical Trends)

### A. 数据颗粒度 (Granularity)
遵循您的要求，摒弃单纯的日线，采用 **30分钟 (30m)** 颗粒度，以还原“主力发动进攻”的具体时刻。

*   **新数据表**: 创建 `history_30m` 表。
    *   字段: `symbol`, `start_time` (e.g., 2023-10-27 10:00:00), `net_inflow`, `main_buy`, `main_sell`, `super_net_inflow` (超大单), `super_buy`, `super_sell`。
*   **清洗逻辑**:
    *   每天收盘后，读取当日 `trade_ticks`。
    *   按 30分钟 划分为 8 个时间段 (09:30-10:00, ..., 14:30-15:00)。
    *   分别计算每个时间段的资金流向并存入新表。

### B. 历史范围与展示
*   **范围**: 支持 **5日**、**10日**、**20日**。
*   **数据量估算**:
    *   5日: 5 × 8 = 40 个点 (清晰)
    *   20日: 20 × 8 = 160 个点 (趋势明显，可接受)
*   **前端交互**:
    *   在历史页面增加 [5日 | 10日 | 20日] 切换按钮。
    *   图表渲染使用新的 `history_30m` 数据源。

## 3. 实施步骤 (Execution Steps)

1.  **环境准备**: 安装 `APScheduler`。
2.  **后端开发**:
    *   创建 `history_30m` 数据库表。
    *   编写 `analysis.py` 中的 `aggregate_30m` 逻辑。
    *   配置 `scheduler.py` 实现 15:05 自动清洗。
    *   编写 `backfill` 脚本，将库中现存的旧数据全部清洗为 30分钟K线。
3.  **API 开发**: 新增 `/api/history/trend` 接口，支持 `days` 参数。
4.  **前端开发**: 改造历史详情页，对接新接口与图表。
