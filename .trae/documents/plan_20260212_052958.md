# 腾讯多空情绪仪表盘 (Sentiment Dashboard) 升级计划 (Revision 2)

感谢您的反馈，**数据持久化**确实是开发期和实战期的关键保障。我们将调整架构，引入 SQLite 本地数据库存储高频快照。

## 1. 核心变更：引入本地数据库持久化
我们将放弃纯内存存储，改用 **SQLite** 作为时序数据库。
*   **优势**：开发期间重启后端服务，历史曲线不会丢失；未来重启电脑也能回溯之前的行情。
*   **性能**：SQLite 写入速度极快（单机每秒可达数万次写入），对于 10 个股票每 3 秒的写入量（每秒仅 3.3 次）可以说是毫无压力。

## 2. 技术实现方案 (Technical Implementation)

### 第一阶段：数据库层 (Database Layer)
1.  **扩展 Schema (`backend/app/db/database.py`)**
    *   新增表 `sentiment_snapshots`：
        ```sql
        CREATE TABLE IF NOT EXISTS sentiment_snapshots (
            symbol TEXT,
            timestamp TEXT,      -- 格式 HH:MM:SS
            date TEXT,           -- 格式 YYYY-MM-DD (用于分区/清理)
            cvd REAL,            -- 累计净主动买入 (Outer - Inner)
            oib REAL,            -- 委差 (Bid1..5 - Ask1..5)
            price REAL,          -- 当前价
            outer_vol INTEGER,   -- 原始外盘
            inner_vol INTEGER,   -- 原始内盘
            UNIQUE(symbol, date, timestamp) -- 防止重复记录
        )
        ```
2.  **CRUD 操作 (`backend/app/db/crud.py`)**
    *   `save_sentiment_snapshot(data_list)`: 批量写入快照。
    *   `get_sentiment_history(symbol, date)`: 读取某日完整曲线。

### 第二阶段：后端监控服务 (Backend Service)
我们将新建一个**独立的高频监控服务**，与现有的 `collector.py` (30秒轮询Sina) 分离，互不干扰。

1.  **新建 `backend/app/services/monitor.py`**
    *   **类**：`SentimentMonitor`
    *   **机制**：
        *   启动 `asyncio` 协程，每 **3秒** 唤醒一次。
        *   读取 `watchlist` 表中的所有股票代码。
        *   构建腾讯批量接口 URL (`q=sh...,sz...`)。
        *   解析返回数据，计算 CVD 和 OIB。
        *   调用 `crud.save_sentiment_snapshot` 存入 SQLite。
2.  **集成 (`backend/app/main.py`)**
    *   在 FastAPI `startup` 事件中启动监控服务。

### 第三阶段：前端可视化 (Frontend)
1.  **新建组件 `SentimentTrend.tsx`**
    *   **图表库**：Recharts
    *   **双图联动**：
        *   上图：**CVD 面积图** (AreaChart)，以 0 轴分红绿。
        *   下图：**OIB 柱状图** (BarChart)，展示多空挂单意愿。
        *   **X轴**：09:30 - 15:00 固定时间轴 (即使当前只有 10:00 的数据，X轴也显示全天，方便看进度)。
2.  **数据获取**
    *   前端不再自己轮询腾讯接口，改为轮询后端 API `GET /api/monitor/history`。
    *   这样前端每次刷新都能拿到后端**持续积累**的完整曲线，即使你刚刚刷新页面。

---

## 3. 业务逻辑确认
*   **CVD (实战)**：反映主动成交的资金流向（累积值）。
*   **OIB (意愿)**：反映盘口挂单的静态压力。
*   **联合研判**：Tooltip 将包含您指定的“背离模型”说明（如：CVD涨+OIB跌=吸筹）。

准备就绪，我们将从数据库层开始实施。