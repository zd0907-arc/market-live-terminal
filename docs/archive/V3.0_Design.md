# V3.0 资金博弈分析模块 - 系统优化方案设计文档

## 1. 项目背景与目标
针对散户用户“看不懂技术黑话”、“需要明确风险提示”以及“网页性能卡顿”的痛点，本项目旨在对现有的资金博弈（Combat Game）模块进行深度重构。
**核心目标**：
1.  **小白化 (User-Friendly)**：将“冰山”、“背离”等技术术语翻译为“主力抢筹”、“抛压沉重”等直观动作。
2.  **风险提示 (Risk-Aware)**：不仅告诉用户发生了什么，更要提示潜在风险（如假突破、诱多）。
3.  **高性能 (Performance)**：采用“历史归档+实时呼吸点”架构，解决大量数据渲染导致的卡顿问题。

## 2. 核心功能定义 (Feature Definitions)

### 2.1 信号重命名与逻辑重构
不再展示原始的单一技术指标，而是通过多因子合成“实战信号”。

| 原技术名 | **新版通俗名** | **图标** | **触发逻辑 (Logic)** | **核心含义** |
| :--- | :--- | :--- | :--- | :--- |
| Violent Engulfing | **🔥 主力抢筹** | 红色火焰 | `Iceberg_Sell` (存在压单) AND `Price_Up` (价格上涨) AND `CVD_Up` (主动买入强) | 有大压单？主力不管，有多少吃多少，硬买上去。 |
| Bearish Rejection | **🧱 抛压沉重** | 灰色砖墙 | `Iceberg_Sell` (存在压单) AND `Price_Down/Flat` (价格滞涨) AND `CVD_Down` (买力不足) | 有大压单，买方怂了，吃不动，价格要跌。 |
| Bullish Support | **🛡️ 主力护盘** | 绿色盾牌 | `Iceberg_Buy` (存在托单) AND `Price_Stable` (价格抗跌) | 有人砸盘？主力在下面接着，砸不下去。 |
| Raw Iceberg | **(隐藏)** | (无) | 单纯的 `Iceberg` 信号若无价格配合，直接过滤。 | 避免误导用户不敢买入。 |
| Exhaustion | **⚠️ 进攻力竭** | ⚠️ 警告标 | 前一分钟发生【主力抢筹】，当前分钟 CVD 走平或下跌。 | 刚才很猛，突然没劲了，警惕诱多。 |

### 2.2 交互设计：1分钟定格 + 3秒呼吸
*   **历史区 (History Zone)**：
    *   显示已结束的分钟级数据。
    *   每分钟一个点，曲线平滑。
    *   数据包含：该分钟收盘时的 CVD、OIB 均值、最强信号。
*   **实时区 (Live Zone)**：
    *   图表最右侧预留 5% 宽度。
    *   **呼吸点 (Pulsing Dot)**：每 3 秒跳动一次，显示当前这一分钟内的**累积变化**。
    *   **动态颜色**：
        *   红色呼吸：当前分钟资金净流入 > 0。
        *   绿色呼吸：当前分钟资金净流入 < 0。
    *   **归档机制**：每当 `ss` 秒归零 (00秒)，当前分钟数据“冻结”并归档到历史区，实时区清零重新开始。

### 2.3 风险提示文案 (Tooltip)
采用三段式结构：
1.  **现象 (Phenomenon)**：客观描述发生了什么（如“检测到巨额压单但价格上涨”）。
2.  **含义 (Implication)**：解释主力意图（如“主力做多意愿极强”）。
3.  **风险 (Risk)**：**最重要**，提示反转条件（如“若CVD停止上涨，注意止损”）。

## 3. 技术架构设计 (Technical Architecture)

### 3.1 数据库设计 (Database)
复用 SQLite，优化表结构以支持信号存储。

*   **表名**: `sentiment_snapshots` (现有)
*   **字段检查**: 确保包含 `signals` (TEXT/JSON) 字段。
*   **归档策略**: 无需单独建立 `history_1m` 表，直接利用 SQL 聚合查询实现分钟级归档。

### 3.2 后端接口 (Backend API)

#### A. 历史数据接口
*   **Endpoint**: `GET /api/market/sentiment/history?symbol=xxx`
*   **Logic**:
    ```sql
    SELECT 
      strftime('%Y-%m-%d %H:%M', timestamp) as minute,
      price as close_price,
      (outer_vol - inner_vol) as cvd_end,
      avg(oib) as oib_avg,
      json_group_array(signals) as minute_signals
    FROM sentiment_snapshots
    WHERE symbol = ? AND date = ?
    GROUP BY minute
    ORDER BY minute ASC
    ```

#### B. 实时流 (WebSocket / Polling)
*   **Endpoint**: `WS /ws/market/realtime` (维持现有机制)
*   **Payload**: 包含 `current_minute_accumulated` 数据，减少前端计算量。

### 3.3 前端实现 (Frontend)
*   **组件**: `SentimentTrend.tsx`
*   **图表库**: Recharts
*   **关键逻辑**:
    *   维护 `historyData` (Array) 和 `liveData` (Object)。
    *   渲染时，将 `liveData` 拼接到 `historyData` 数组末尾。
    *   使用 `ReferenceDot` 实现呼吸点效果。
    *   `CustomTooltip` 组件解析 HTML 内容。

## 4. 实施计划 (Implementation Plan)

1.  **数据库迁移**: 检查并修复 `sentiment_snapshots` 表结构。
2.  **后端算法**: 更新 `monitor.py` 中的信号判定逻辑。
3.  **API开发**: 新增 `get_history` 聚合函数。
4.  **前端重构**: 改造 `SentimentTrend` 组件，实现呼吸点与新版 Tooltip。
5.  **测试**: 模拟数据验证“主力抢筹”与“进攻力竭”场景。
