# 业务逻辑说明书 (Business Logic)

本文档详细定义了本项目中的核心金融概念与算法逻辑，旨在帮助开发者（包括 AI）准确理解业务背景。

## 1. 资金流向定义

我们通过对逐笔交易（Tick Data）的金额进行分类，来判断资金的性质（主力 vs 散户）。

### 1.1 资金分类标准
*   **主力 (Main Force)**: 单笔交易金额 $\ge$ `large_threshold` (默认 **20万元**)。
*   **超大单 (Super Large)**: 单笔交易金额 $\ge$ `super_large_threshold` (默认 **100万元**)。
*   **散户 (Retail)**: 单笔交易金额 $<$ `large_threshold`。

> **注意**: 阈值配置存储在数据库 `app_config` 表中，可通过前端设置面板动态调整。

### 1.2 核心指标计算
*   **主力净流入 (Net Inflow)**:
    $$ \text{主力净流入} = \sum(\text{主力买入额}) - \sum(\text{主力卖出额}) $$
*   **主力参与度 (Participation Ratio)**:
    $$ \text{参与度} = \frac{\text{主力买入额} + \text{主力卖出额}}{\text{总成交额}} \times 100\% $$
    *   该指标反映了主力资金在当前交易中的控盘程度。

---

## 2. 微观博弈 (Micro-Structure)

利用腾讯行情快照（3秒/次）的买一/卖一挂单变化，推断主力的隐形操盘手法。

### 2.1 冰山压单 (Iceberg Sell Order)
*   **场景**: 主力想出货，但不敢在卖一挂大单吓跑买盘，于是挂小单，成交后瞬间补单。
*   **特征**: 外盘（主动买入）大量成交，但卖一挂单量不减反增（或减少量远小于成交量）。
*   **判定逻辑**:
    1.  `外盘增量` > 500手。
    2.  `隐形补单量` > `外盘增量` * 0.8。
    3.  其中 `隐形补单量 = (当前卖一 - 上次卖一) + 外盘增量`。

### 2.2 虚假撤托 (Spoofing Buy)
*   **场景**: 主力在买一挂大单诱多，当价格快跌到买一价时，瞬间撤单。
*   **特征**: 内盘（主动卖出）很小，但买一挂单量突然断崖式下跌。
*   **判定逻辑**:
    1.  `内盘增量` < 100手（几乎没成交）。
    2.  `买一变化量` < -1000手（大单撤退）。

---

## 3. 散户情绪 (Retail Sentiment)

通过爬取股吧/社区评论，量化散户的市场情绪。

### 3.1 情绪评分 (Sentiment Score)
*   范围: 0 (极度悲观) - 10 (极度乐观)。
*   **关键词库**:
    *   **加分项**: "吃肉", "起飞", "涨停", "主力进场"。
    *   **减分项**: "核按钮", "织布", "出货", "套牢"。

### 3.2 AI 摘要
*   使用 LLM (如 DeepSeek/OpenAI) 对最近 50 条高热度评论进行总结。
*   **生成时机**: 用户手动触发或每日定时任务。
*   **价值**: 快速了解市场在讨论该股票的什么利好/利空（如“重组传闻”、“业绩暴雷”）。
